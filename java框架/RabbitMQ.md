### RabbitMQ

***

1. ##### 什么是RabbitMQ？

   [全面解释]( https://www.cnblogs.com/williamjie/p/9481774.html )

   AMQP，即Advanced Message Queuing Protocol，高级消息队列协议，是应用层协议的一个开放标准，为面向消息的[中间件](http://www.diggerplus.org/archives/tag/中间件)设计。消息中间件主要用于组件之间的解耦，消息的发送者无需知道消息使用者的存在，反之亦然。
   AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。
   RabbitMQ是一个开源的AMQP实现，服务器端用Erlang语言编写，支持多种客户端，如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP等，支持AJAX。**用于在分布式系统中存储转发消息，在易用性、扩展性、高可用性等方面表现不俗。** 

2. ##### RabbitMQ的使用场景有那些？

   - 抢购活动，削峰填谷，防止系统崩溃。
   - 延迟信息处理，比如10分钟之后可以给下单未付款的用户发送邮件提醒。
   - 解耦系统，对于新增的功能可以单独写模块扩展，比如用户确认评价之后，新增了给用户返积分的功能，这个时候不用在业务代码里添加新增积分的功能，只需要把新增积分的接口订阅确认评价的消息队列即可，后面再添加任何功能只需要订阅对应的消息队列即可。 
   - 订单系统：用户下单后，订单系统完成持久化处理，将消息写入消息队列，返回用户订单下单成功。
   - 库存系统：订阅下单的消息，采用推/拉的方式，获取下单信息，库存系统根据下单信息，进行库存操作。

3. ##### RabbitMQ有哪些重要的角色？

   - 生产者：消息的创建者，负责创建和推送数据到消息服务器。
   - 消费者：消息的接收方，用于处理数据和确认消息。
   - 代理：就是RabbitMQ本身，用于扮演快递的角色，本身不产生消息，只是扮演快递的角色。

4. ##### RabbitMQ有哪些重要的组件？

   - ConnectionFactory：连接管理器，应用程序与Rabbit之间建立连接的管理器，程序代码中使用。
   - Connection：RabbitMQ的socket连接，封装了socket协议相关部分。
   - Channel：信道，消息推送使用的通道。
   - Exchange：交换器，用于接收，分配消息。
   - Queue：队列，用于存储生产者的消息。
   - RoutingKey：路由键，用于把生产者的数据分配到交换机上。
   - BindingKey：绑定键，用于把交换机的消息绑定到队列上。

5. ###### RabbitMQ中vhost的作用是什么？

   vhost本质上是一个mini版的RabbitMQ服务器，拥有自己的队列、绑定、交换器和权限控制；

   vhost通过在各个实例间提供逻辑上分离，允许你为不同应用程序安全保密地运行数据；

   vhost是AMQP概念的基础，必须在连接时进行指定，RabbitMQ包含了默认vhost：“/”；

   当在RabbitMQ中创建一个用户时，用户通常会被指派给至少一个vhost，并且只能访问被指派vhost内的队列、交换器和绑定，vhost之间是绝对隔离的。

   vhost操作：

   ```java
   rabbitmqctl add_vhost [vhost_name] #创建vhost
    
   rabbitmqctl delete_vhost [vhost_name] #删除vhost
    
   rabbitmqctl list_vhosts #查看
    
   #配置最大连接限制，0：表示不可用，-1：无限制
    
   rabbitmqctl set_vhost_limits -p vhost_name '{"max-connections": 256}'
    
   #配置队列最大数，-1：无限制
    
   rabbitmqctl set_vhost_limits -p vhost_name '{"max-queues": 1024}'
   ```

6. ##### RabbitMQ的消息是怎么发送的？

   首先客户端必须连接到RabbitMQ服务器才能发布和消费信息，客户端和Rabbit Server之间会创建一个tcp连接，一但tcp打开并通过了认证（认证就是你发送给给rabbit服务器的用户名和密码），你的客户端和RabbitMQ就创建了一条amqp信道（channel），信道是创建在真实tcp上的虚拟连接，amqp命令都是通过信道发送出去的，每个信道都会有一个唯一的id，不论是发布消息，订阅队列都是通过这个信道完成的。

7. ##### RabbitMQ怎么保证消息的稳定性？

   - 提供了事务的支持。
   - 通过将channel设置为confirm模式。

8. ##### RabbitMQ怎么避免消息丢失?

   把消息持久化到磁盘，保服务器重启消息不丢失。

9. ##### 要保证消息持久化成功的条件有哪些？

   须同时具备：

   - 声明队列必须设置持久化durable为true。
   - 消息推送投递模式必须设置持久化，deliveryMode设置为2（持久）。
   - 消息已经到达持久化交换器。
   - 消息已经到达持久化队列。

10. ##### RabbitMQ持久化有什么缺点?

    降低了服务器的吞吐量，引用的是磁盘而不是内存存储。可使用ssd硬盘来缓解吞吐量的问题。

11. ##### RabbitMQ有几种广播类型？

    - direct（默认方式）：最基础最简单的模式，发送方把消息发送给订阅方，如果有多个订阅者，默认采取轮询的方式进行消息发送。

    - headers：与 direct 类似，只是性能很差，此类型几乎用不到。
    - fanout：分发模式，把消费分发给所有订阅者。
    - topic：匹配订阅模式，使用正则匹配到消息队列，能匹配到的都能接收到。

12. ##### RabbitMQ怎么实现延迟消息队列？

    两种方式：

    - 通过消息过期后进入死信交换器，再由交换器转发到延迟消费队列，实现延迟功能。
    - 使用RabbitMQ-delayed-message-exchange插件实现延迟功能。

13. ##### RabbitMQ集群有什么用？

    - 高可用：某个服务器出现问题，整个RabbitMQ还可以继续使用。
    - 高容量：集群可以承载更多的消息量。

14. ##### RabbitMQ节点的类型有哪些？

    - 磁盘节点：消息会存储在磁盘。
    - 内存结点：消息都存储在内存中，重启服务器消息丢失，性能高于磁盘类型。

15. ##### RabbitMQ集群搭建需要注意哪些问题？

    - 各节点之间使用“--link”连接，该属性不能忽略。
    - 整个集群中必须包含至少一个磁盘节点，保证消息落入磁盘。
    - 各节点使用的erlang cookie值必须相同，此值相当于密钥的功能，用于各节点的认证。

16. ##### RabbitMQ每个节点是其他节点的完整拷贝么？为什么？

    不是，原因如下：

    - 存储空间的考虑：如果每个节点都拥有所有队列的完全拷贝，这样新增节点不但没有新增存储空间，反而增加了更多的冗余数据；
    - 性能的考虑：如果每条消息都需要完整拷贝到每一个集群节点，那新增节点并没有提升处理消息的能力，最多是保持和单节点相同的性能甚至是更糟。

17. ##### RabbitMQ集群中唯一一个磁盘节点崩溃了会发生什么情况？

    唯一磁盘节点崩溃了，集群是可以保持运行的，但你不能更改任何东西。

    - 不能创建队列
    - 不能创建交换器
    - 不能创建绑定
    - 不能添加用户
    - 不能更改权限
    - 不能添加和删除集群节点

18. ##### RabbitMQ对集群节点停止有什么顺序要求么？

    RabbitMQ 对集群的停止的顺序是有要求的，应该先关闭内存节点，最后再关闭磁盘节点。如果顺序恰好相反的话，可能会造成消息的丢失。 